---

- name: create a new ACL token
  consul_acl:
    host: '{{ acl_host }}'
    mgmt_token: '{{ mgmt_token }}'
    name: 'New ACL'
  register: created_ruleless_acl

- name: verify ACL created without rules
  assert:
    that:
      - created_ruleless_acl.changed
      - created_ruleless_acl.token | length == 36
      - created_ruleless_acl.name == 'New ACL'
      - created_ruleless_acl.rules == {}

- name: create an ACL with rules
  consul_acl:
    host: '{{ acl_host }}'
    mgmt_token: '{{ mgmt_token }}'
    name: 'With rule'
    rules:
      - key: 'foo'
        policy: read
      - key: 'private/bar'
        policy: deny
  register: created_acl

- name: verify created ACL's rules
  assert:
    that:
      - created_ruleless_acl.changed
      - created_acl.token | length == 36
      - created_acl.name == 'With rule'
      - (created_acl.rules | json_query("key.foo.policy")) == "read"
      - (created_acl.rules | json_query("key.'private/bar'.policy")) == "deny"

- name: change rules of existing ACL
  consul_acl:
    host: '{{ acl_host }}'
    token: '{{ created_acl.token }}'
    rules:
      - key: 'foo'
        policy: write
      - key: 'moo'
        policy: deny
  register: updated_acl

- name: verify updated ACL's rules
  assert:
    that:
      - created_ruleless_acl.changed
      - (updated_acl.rules | json_query("key.foo.policy")) == "write"
      - (created_acl.rules | json_query("key.'private/bar'.policy")) == "deny"
      - (updated_acl.rules | json_query("key.moo.policy")) == "deny"

- name: clear up
  consul_acl:
    host: '{{ acl_host }}'
    mgmt_token: '{{ mgmt_token }}'
    token: '{{ item }}'
    state: absent
  with_items:
    - '{{ created_ruleless_acl.token }}'
    - '{{ created_acl.token }}'
